---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: image-updater
  labels:
    app: watchclub
    component: image-updater

---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: image-updater
  labels:
    app: watchclub
    component: image-updater
rules:
- apiGroups: ["apps"]
  resources: ["statefulsets", "deployments"]
  verbs: ["get", "patch"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: image-updater
  labels:
    app: watchclub
    component: image-updater
subjects:
- kind: ServiceAccount
  name: image-updater
roleRef:
  kind: Role
  name: image-updater
  apiGroup: rbac.authorization.k8s.io

---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: image-updater
  labels:
    app: watchclub
    component: image-updater
spec:
  schedule: "*/5 * * * *"  # Every 5 minutes
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: watchclub
            component: image-updater
        spec:
          serviceAccountName: image-updater
          restartPolicy: OnFailure
          containers:
          - name: updater
            image: ghcr.io/cartermckinnon/watchclub/crane:latest
            command:
            - bash
            - -c
            - |
              set -e

              NAMESPACE=$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace)
              UPDATED=0

              echo "üîç Checking for image updates..."

              update_image() {
                local RESOURCE_TYPE=$1
                local RESOURCE_NAME=$2
                local CONTAINER_NAME=$3
                local IMAGE_NAME=$4
                local IMAGE_TAG=$5

                echo "üì¶ Checking ${RESOURCE_TYPE}/${RESOURCE_NAME}..."

                CURRENT_IMAGE=$(kubectl get $RESOURCE_TYPE $RESOURCE_NAME -n $NAMESPACE -o jsonpath="{.spec.template.spec.containers[?(@.name=='$CONTAINER_NAME')].image}")
                echo "   Current: $CURRENT_IMAGE"

                echo "   Querying registry for ${IMAGE_NAME}:${IMAGE_TAG}..."
                NEW_DIGEST=$(crane digest "${IMAGE_NAME}:${IMAGE_TAG}" 2>&1)

                if [ $? -ne 0 ] || [ -z "$NEW_DIGEST" ]; then
                  echo "   ‚ö†Ô∏è  WARNING: Could not query registry"
                  echo "   Output: $NEW_DIGEST"
                  return 1
                fi

                NEW_IMAGE="${IMAGE_NAME}@${NEW_DIGEST}"
                echo "   Latest:  $NEW_IMAGE"

                # Check if update is needed
                if [ "$CURRENT_IMAGE" = "$NEW_IMAGE" ]; then
                  echo "   ‚úì Already up to date"
                  return 0
                fi

                echo "   ‚ö° New image detected, updating..."
                kubectl set image $RESOURCE_TYPE/$RESOURCE_NAME -n $NAMESPACE \
                  ${CONTAINER_NAME}="${NEW_IMAGE}"

                if [ $? -eq 0 ]; then
                  echo "   ‚úì Updated successfully"
                  UPDATED=1
                else
                  echo "   ‚ùå Update failed"
                  return 1
                fi
              }

              # backend
              update_image "statefulset" "backend" "server" \
                "ghcr.io/cartermckinnon/watchclub" "dev"

              # frontend
              update_image "deployment" "frontend" "frontend" \
                "ghcr.io/cartermckinnon/watchclub/ui" "dev"

              if [ $UPDATED -eq 1 ]; then
                echo "Images updated"
              else
                echo "All images are up to date"
              fi
